name: Points Calculator

on:
  pull_request:
    types: [closed]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  calculate-points:
    # Only run when PR is actually merged, not just closed
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Calculate and Award Points
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const prNumber = pr.number;
            const prTitle = pr.title;
            const prUrl = pr.html_url;
            const author = pr.user.login;
            const repo = context.repo.repo;

            // â”€â”€ Extract team number â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const teamMatch = body.match(/team\s*(\d+)/i);
            if (!teamMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ğŸ”´ Points Not Awarded

This PR was merged but **no team number was found** in the description.

Please contact the organizers to have your points manually added:
- ğŸ“± **WhatsApp:** +91-8347036131
- ğŸ“§ **Email:** jadejakrishnapal04@gmail.com

> ğŸš€ **GDG CHARUSAT Open Source Contri Sprintathon**`
              });
              return;
            }

            const teamNumber = teamMatch[1].padStart(2, '0');
            const teamLabel = `Team ${teamNumber}`;

            // â”€â”€ Check for linked issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const issueMatch = body.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#(\d+)/i);
            const hasLinkedIssue = Boolean(issueMatch);

            let points = 0;
            let level = '';
            let pointSource = '';

            // â”€â”€ CASE A: Issue-linked PR â†’ read points from issue label â”€â”€â”€â”€â”€
            if (hasLinkedIssue) {
              const issueNumber = parseInt(issueMatch[3]);
              pointSource = `Linked Issue #${issueNumber}`;

              try {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                const labels = issue.data.labels.map(l => l.name.toLowerCase());
                console.log(`Issue #${issueNumber} labels: ${labels.join(', ')}`);

                if (labels.includes('level-2') || labels.includes('intermediate')) {
                  points = 20;
                  level = 'ğŸŸ¡ Level 2 â€” Intermediate';
                } else if (
                  labels.includes('level-1') ||
                  labels.includes('beginner') ||
                  labels.includes('good-first-issue')
                ) {
                  points = 5;
                  level = 'ğŸŸ¢ Level 1 â€” Beginner';
                } else {
                  // Issue has no level label â€” fall back to PR labels
                  points = await getPointsFromPRLabels(pr);
                  level = points === 20
                    ? 'ğŸŸ¡ Level 2 â€” Intermediate (from PR label)'
                    : 'ğŸŸ¢ Level 1 â€” Beginner (from PR label)';
                }

              } catch (e) {
                console.log(`Could not fetch issue #${issueNumber}: ${e.message}`);
                points = 5;
                level = 'ğŸŸ¢ Level 1 â€” Beginner (fallback)';
              }

            // â”€â”€ CASE B: General improvement PR â†’ read points from PR labels â”€
            } else {
              pointSource = 'General Improvement PR â€” level assigned by admin';
              points = await getPointsFromPRLabels(pr);

              if (points === 0) {
                // Admin forgot to assign a level label before merging
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `## âš ï¸ Points Could Not Be Calculated

This is a **General Improvement PR** but no level label (\`level-1\` or \`level-2\`) was found on this PR.

**Admin action required:**
Please manually add points for **${teamLabel}** in the leaderboard issue.

- \`level-1\` = **5 points**
- \`level-2\` = **20 points**

> ğŸš€ **GDG CHARUSAT Open Source Contri Sprintathon**`
                });
                return;
              }

              level = points === 20
                ? 'ğŸŸ¡ Level 2 â€” Intermediate (admin assigned)'
                : 'ğŸŸ¢ Level 1 â€” Beginner (admin assigned)';
            }

            // â”€â”€ Post points comment on PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ğŸ‰ PR Merged â€” Points Awarded!

Congratulations @${author}! Your contribution has been merged.

| | |
|---|---|
| ğŸ‘¥ **Team** | ${teamLabel} |
| ğŸ·ï¸ **Level** | ${level} |
| â­ **Points Awarded** | **${points} points** |
| ğŸ“Œ **Source** | ${pointSource} |

The leaderboard has been updated. Keep contributing! ğŸ’ª

> ğŸš€ **GDG CHARUSAT Open Source Contri Sprintathon**`
            });

            // â”€â”€ Update leaderboard pinned issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await updateLeaderboard(teamLabel, points, repo);

            // â”€â”€ Helper: Read level from PR's own labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async function getPointsFromPRLabels(pr) {
              const prLabels = pr.labels.map(l => l.name.toLowerCase());
              console.log(`PR labels: ${prLabels.join(', ')}`);

              if (prLabels.includes('level-2') || prLabels.includes('intermediate')) {
                return 20;
              } else if (
                prLabels.includes('level-1') ||
                prLabels.includes('beginner') ||
                prLabels.includes('good-first-issue')
              ) {
                return 5;
              }
              return 0; // No level label found
            }

            // â”€â”€ Helper: Update leaderboard issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async function updateLeaderboard(team, pts, repoName) {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'leaderboard',
                per_page: 1
              });

              const scores = {};
              let leaderboardIssueNumber = null;

              if (issues.data.length > 0) {
                const lb = issues.data[0];
                leaderboardIssueNumber = lb.number;
                Object.assign(scores, parseLeaderboard(lb.body || ''));
              }

              // Add points
              if (!scores[team]) scores[team] = { points: 0, prs: 0 };
              scores[team].points += pts;
              scores[team].prs += 1;

              const newBody = buildLeaderboardBody(scores, repoName);

              if (leaderboardIssueNumber) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: leaderboardIssueNumber,
                  body: newBody
                });
                console.log(`Leaderboard updated. ${team} now has ${scores[team].points} pts.`);
              } else {
                // Create leaderboard issue if it doesn't exist
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ğŸ† Sprintathon Leaderboard',
                  body: newBody,
                  labels: ['leaderboard']
                });
                console.log('Leaderboard issue created.');
              }
            }

            // â”€â”€ Helper: Parse existing leaderboard table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function parseLeaderboard(body) {
              const scores = {};
              const rowRegex = /\|\s*(Team\s*\d+)\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|/gi;
              let match;
              while ((match = rowRegex.exec(body)) !== null) {
                scores[match[1].trim()] = {
                  points: parseInt(match[2]),
                  prs: parseInt(match[3])
                };
              }
              return scores;
            }

            // â”€â”€ Helper: Build leaderboard markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function buildLeaderboardBody(scores, repoName) {
              const sorted = Object.entries(scores)
                .sort((a, b) => b[1].points - a[1].points);

              const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
              const rows = sorted.map(([team, data], i) => {
                const rank = medals[i] || `${i + 1}.`;
                return `| ${rank} | ${team} | ${data.points} | ${data.prs} |`;
              }).join('\n');

              const now = new Date().toUTCString();

              return `# ğŸ† GDG CHARUSAT Open Source Contri Sprintathon â€” Leaderboard

> **Repository:** \`${repoName}\`
> **Last Updated:** ${now}

---

## ğŸ“Š Scores

| Rank | Team | â­ Points | âœ… PRs Merged |
|------|------|-----------|--------------|
${rows || '| â€” | No contributions yet | 0 | 0 |'}

---

## ğŸ¯ Points System

| Level | Label | Points |
|-------|-------|--------|
| ğŸŸ¢ Beginner | \`level-1\` / \`good-first-issue\` | 5 pts |
| ğŸŸ¡ Intermediate | \`level-2\` / \`intermediate\` | 20 pts |
| ğŸ”§ General Improvement | Admin assigns \`level-1\` or \`level-2\` on PR | 5 or 20 pts |

---

*This leaderboard updates automatically every time a PR is merged. ğŸ¤–*
*Maintained by GDG CHARUSAT ğŸš€*`;
            }
